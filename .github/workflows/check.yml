name: Checks

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches:
      - main

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    runs-on: ubuntu-20.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Setup
        id: setup
        uses: ./.github/actions/setup

      - name: Lint GitHub actions
        run: yarn github-actions:lint

      - name: Lint generators
        run: |
          yarn cli format java generators
          diff=$(git status --porcelain ./generators | wc -l)
          if [[ $diff > 0 ]]; then
            echo "Format the generators folder by running 'yarn docker format java generators'"
          fi
          exit $diff

      - name: Lint json files
        run: yarn eslint --ext=json .

    outputs:
      RUN_SCRIPTS: ${{ steps.setup.outputs.RUN_SCRIPTS }}

      RUN_SPECS: ${{ steps.setup.outputs.RUN_SPECS }}
      SPECS_MATRIX: ${{ steps.setup.outputs.SPECS_MATRIX }}

      RUN_JS: ${{ steps.setup.outputs.RUN_JS }}
      RUN_JS_ALGOLIASEARCH: ${{ steps.setup.outputs.RUN_JS_ALGOLIASEARCH }}
      RUN_JS_COMMON: ${{ steps.setup.outputs.RUN_JS_COMMON }}
      RUN_JS_TESTS: ${{ steps.setup.outputs.RUN_JS_TESTS }}
      JS_MATRIX: ${{ steps.setup.outputs.JS_MATRIX }}

      RUN_JAVA: ${{ steps.setup.outputs.RUN_JAVA }}
      JAVA_MATRIX: ${{ steps.setup.outputs.JAVA_MATRIX }}

      RUN_PHP: ${{ steps.setup.outputs.RUN_PHP }}
      PHP_MATRIX: ${{ steps.setup.outputs.PHP_MATRIX }}

      RUN_CTS: ${{ steps.setup.outputs.RUN_CTS }}

      RUN_CODEGEN: ${{ steps.setup.outputs.RUN_CODEGEN }}

  scripts:
    runs-on: ubuntu-20.04
    timeout-minutes: 10
    needs: setup
    if: ${{ needs.setup.outputs.RUN_SCRIPTS == 'true' }}
    steps:
      - uses: actions/checkout@v2

      - name: Restore cache
        uses: ./.github/actions/cache

      - name: Check script linting
        run: yarn scripts:lint

      - name: Test scripts
        run: yarn scripts:test

      - name: Test custom eslint plugin
        run: yarn workspace eslint-plugin-automation-custom test

  specs:
    runs-on: ubuntu-20.04
    timeout-minutes: 10
    needs: setup
    if: ${{ needs.setup.outputs.RUN_SPECS == 'true' }}
    strategy:
      matrix: ${{ fromJSON(needs.setup.outputs.SPECS_MATRIX) }}
    steps:
      - uses: actions/checkout@v2

      - name: Restore cache
        uses: ./.github/actions/cache

      - name: Cache '${{ matrix.client.name }}' bundled specs
        id: cache
        uses: actions/cache@v2
        with:
          path: ${{ matrix.client.bundledPath }}
          key: |
            ${{ env.CACHE_VERSION }}-${{
            hashFiles(
              format('{0}/**', matrix.client.path),
              'specs/common/**'
            )}}

      - name: Building '${{ matrix.client.name }}' specs
        if: steps.cache.outputs.cache-hit != 'true'
        run: yarn cli build specs ${{ matrix.client.name }}

  client_javascript_common:
    timeout-minutes: 10
    runs-on: ubuntu-20.04
    needs: setup
    if: ${{ needs.setup.outputs.RUN_JS_COMMON == 'true' }}
    strategy:
      matrix:
        client:
          - client-common
          - requester-browser-xhr
          - requester-node-http
    steps:
      - uses: actions/checkout@v2

      - name: Restore cache
        uses: ./.github/actions/cache

      - name: Cache '${{ matrix.client }}' client
        id: cache
        uses: actions/cache@v2
        with:
          path: clients/algoliasearch-client-javascript/packages/${{ matrix.client }}
          key: |
            ${{ env.CACHE_VERSION }}-${{
            hashFiles(
              format('clients/algoliasearch-client-javascript/packages/{0}/src/**', matrix.client)
            )}}

      - name: Build '${{ matrix.client }}' client
        if: steps.cache.outputs.cache-hit != 'true'
        run: yarn workspace algoliasearch-client-javascript build ${{ matrix.client }}

  client_javascript:
    timeout-minutes: 10
    runs-on: ubuntu-20.04
    needs:
      - setup
      - specs
      - client_javascript_common
    if: |
      always() &&
      needs.setup.outputs.RUN_JS == 'true' &&
      !contains(needs.*.result, 'cancelled') &&
      !contains(needs.*.result, 'failure')
    strategy:
      matrix: ${{ fromJSON(needs.setup.outputs.JS_MATRIX) }}
    steps:
      - uses: actions/checkout@v2

      - name: Restore cache
        uses: ./.github/actions/cache
        with:
          job: client
          language: javascript

      - name: Cache '${{ matrix.client.name }}' client
        id: cache
        uses: actions/cache@v2
        with:
          path: ${{ matrix.client.path }}
          key: |
            ${{ env.CACHE_VERSION }}-${{
            hashFiles(
              format('{0}/src/**', matrix.client.path),
              format('{0}/model/**', matrix.client.path),
              format('{0}/builds/**', matrix.client.path),
              format('{0}/package.json', matrix.client.path),
              format('specs/bundled/{0}.yml', matrix.client.name),
              'templates/javascript/**',
              'generators/src/**'
            )}}

      - name: Generate '${{ matrix.client.name }}' client
        if: steps.cache.outputs.cache-hit != 'true'
        run: yarn cli generate javascript ${{ matrix.client.name }}

      - name: Build '${{ matrix.client.name }}' client
        if: steps.cache.outputs.cache-hit != 'true'
        run: yarn cli build clients javascript ${{ matrix.client.name }}

      - name: Show diff for '${{ matrix.client.name }}' client
        if: steps.cache.outputs.cache-hit != 'true'
        run: git --no-pager diff

  client_java:
    runs-on: ubuntu-20.04
    timeout-minutes: 10
    needs:
      - setup
      - specs
    if: |
      always() &&
      needs.setup.outputs.RUN_JAVA == 'true' &&
      !contains(needs.*.result, 'cancelled') &&
      !contains(needs.*.result, 'failure')
    strategy:
      matrix: ${{ fromJSON(needs.setup.outputs.JAVA_MATRIX) }}
    steps:
      - uses: actions/checkout@v2

      - name: Restore cache
        uses: ./.github/actions/cache
        with:
          job: client
          language: java

      - name: Cache '${{ matrix.client.name }}' client
        id: cache
        uses: actions/cache@v2
        with:
          path: ${{ matrix.client.path }}
          key: |
            ${{ env.CACHE_VERSION }}-${{
            hashFiles(
              format('{0}/{1}/**', matrix.client.path, matrix.client.name),
              format('{0}/model/{1}/**', matrix.client.path, matrix.client.name),
              format('specs/bundled/{0}.yml', matrix.client.name),
              'templates/java/**',
              'generators/src/**'
            )}}

      - name: Generate '${{ matrix.client.name }}' client
        if: steps.cache.outputs.cache-hit != 'true'
        run: yarn cli generate java ${{ matrix.client.name }}

      - name: Build '${{ matrix.client.name }}' client
        if: steps.cache.outputs.cache-hit != 'true'
        run: yarn cli build clients java ${{ matrix.client.name }}

      - name: Show diff for '${{ matrix.client.name }}' client
        if: steps.cache.outputs.cache-hit != 'true'
        run: git --no-pager diff

  client_php:
    runs-on: ubuntu-20.04
    timeout-minutes: 10
    needs:
      - setup
      - specs
    if: |
      always() &&
      needs.setup.outputs.RUN_PHP == 'true' &&
      !contains(needs.*.result, 'cancelled') &&
      !contains(needs.*.result, 'failure')
    strategy:
      matrix: ${{ fromJSON(needs.setup.outputs.PHP_MATRIX) }}
    steps:
      - uses: actions/checkout@v2

      - name: Restore cache
        uses: ./.github/actions/cache
        with:
          job: client
          language: php

      - name: Cache '${{ matrix.client.name }}' client
        id: cache
        uses: actions/cache@v2
        with:
          path: |
            ${{ format('{0}/lib/Api/{1}.php', matrix.client.folder, matrix.client.api) }}
            ${{ format('{0}/lib/Model/{1}/**', matrix.client.folder, matrix.client.capitalizedName) }}
          key: |
            ${{ env.CACHE_VERSION }}-${{
            hashFiles(
              format('{0}/lib/Api/{1}.php', matrix.client.folder, matrix.client.api),
              format('{0}/lib/Configuration/{1}.php', matrix.client.folder, matrix.client.config),
              format('{0}/lib/Model/{1}/**', matrix.client.folder, matrix.client.capitalizedName),
              format('specs/bundled/{0}.yml', matrix.client.name),
              'templates/php/**',
              'generators/src/**'
            )}}

      - name: Generate '${{ matrix.client.name }}' client
        if: steps.cache.outputs.cache-hit != 'true'
        run: yarn cli generate php ${{ matrix.client.name }}

      - name: Build '${{ matrix.client.name }}' client
        if: steps.cache.outputs.cache-hit != 'true'
        run: yarn cli build clients php ${{ matrix.client.name }}

      - name: Show diff for '${{ matrix.client.name }}' client
        if: steps.cache.outputs.cache-hit != 'true'
        run: git --no-pager diff

  client_javascript_algoliasearch:
    timeout-minutes: 10
    runs-on: ubuntu-20.04
    needs: client_javascript
    if: |
      always() &&
      needs.setup.outputs.RUN_JS_ALGOLIASEARCH == 'true' &&
      !contains(needs.*.result, 'cancelled') &&
      !contains(needs.*.result, 'failure')
    steps:
      - uses: actions/checkout@v2

      - name: Restore cache
        uses: ./.github/actions/cache
        with:
          job: codegen
          language: javascript

      - name: Cache 'algoliasearch' client
        id: cache
        uses: actions/cache@v2
        with:
          path: clients/algoliasearch-client-javascript/packages/algoliasearch
          key: |
            ${{ env.CACHE_VERSION }}-${{
            hashFiles(
              'clients/algoliasearch-client-javascript/packages/algoliasearch/**',
              'clients/algoliasearch-client-javascript/packages/client-search/**',
              'clients/algoliasearch-client-javascript/packages/client-analytics/**',
              'clients/algoliasearch-client-javascript/packages/client-personalization/**'
            )}}

      - name: Build 'algoliasearch' client
        if: steps.cache.outputs.cache-hit != 'true'
        run: yarn cli build clients javascript algoliasearch

  client_javascript_tests:
    runs-on: ubuntu-20.04
    timeout-minutes: 10
    needs: client_javascript
    if: |
      always() &&
      needs.setup.outputs.RUN_JS_TESTS == 'true' &&
      !contains(needs.*.result, 'cancelled') &&
      !contains(needs.*.result, 'failure')
    steps:
      - uses: actions/checkout@v2

      - name: Restore cache
        uses: ./.github/actions/cache
        with:
          job: cts

      - name: Run client-common tests
        run: yarn workspace @experimental-api-clients-automation/client-common test

  cts:
    runs-on: ubuntu-20.04
    timeout-minutes: 20
    needs:
      - client_javascript
      - client_java
      - client_php
    if: |
      always() &&
      needs.setup.outputs.RUN_CTS == 'true' &&
      !contains(needs.*.result, 'cancelled') &&
      !contains(needs.*.result, 'failure')
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.TOKEN_RELEASE_BOT }}

      - name: Restore cache
        uses: ./.github/actions/cache
        with:
          job: cts

      - name: Push generated code to generated branch
        id: pushGeneratedCode
        if: github.event_name == 'pull_request'
        run: yarn workspace scripts pushGeneratedCode
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_GENERATE_BOT }}
          PR_NUMBER: ${{ github.event.number }}

      - name: Check JavaScript client size
        run: exit $(yarn workspace algoliasearch-client-javascript test:size | echo $?)

      - name: Generate
        run: yarn cli cts generate

      - name: Check diff with pushed CTS
        run: |
          git --no-pager diff
          exit $(git status --porcelain ./tests/output | wc -l)

      - name: Run
        run: yarn cli cts run

  codegen_on_main:
    runs-on: ubuntu-20.04
    timeout-minutes: 10
    needs:
      - cts
      - client_javascript_tests
      - client_javascript_algoliasearch
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      needs.setup.outputs.RUN_CODEGEN == 'true' &&
      needs.cts.result == 'success'
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.TOKEN_RELEASE_BOT }}

      - name: Restore cache
        uses: ./.github/actions/cache
        with:
          job: codegen

      - name: Push generated code to main
        id: pushGeneratedCode
        run: yarn workspace scripts pushGeneratedCode
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_GENERATE_BOT }}

      - name: Spread generation to each repository
        if: steps.pushGeneratedCode.exitcode == 0
        run: yarn workspace scripts spreadGeneration
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_RELEASE_BOT }}
