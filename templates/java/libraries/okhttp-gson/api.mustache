package {{package}};

import {{invokerPackage}}.ApiClient;

import com.google.gson.reflect.TypeToken;

import okhttp3.Call;
import okhttp3.Request;

import com.algolia.utils.*;
import {{modelPackage}}.*;
import com.algolia.exceptions.*;
import com.algolia.utils.retry.CallType;
import com.algolia.utils.retry.StatefulHost;

import java.util.EnumSet;
import java.util.Random;
import java.util.Collections;
import java.lang.reflect.Type;
{{^fullJavaUtil}}
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
{{/fullJavaUtil}}
import java.util.stream.Collectors;
import java.util.stream.Stream;
import java.util.concurrent.CompletableFuture;

{{#operations}}
public class {{classname}} extends ApiClient {
    {{#hasRegionalHost}}
    {{#fallbackToAliasHost}}
    public {{classname}}(String appId, String apiKey) {
        this(appId, apiKey, new HttpRequester(getDefaultHosts(null)), null);
    }

    public {{classname}}(String appId, String apiKey, UserAgent.Segment[] userAgentSegments) {
        this(appId, apiKey, new HttpRequester(getDefaultHosts(null)), userAgentSegments);
    }
    
    {{/fallbackToAliasHost}}
    public {{classname}}(String appId, String apiKey, String region) {
        this(appId, apiKey, new HttpRequester(getDefaultHosts(region)), null);
    }

    public {{classname}}(String appId, String apiKey, String region, UserAgent.Segment[] userAgentSegments) {
        this(appId, apiKey, new HttpRequester(getDefaultHosts(region)), userAgentSegments);
    }
    {{/hasRegionalHost}}

    {{^hasRegionalHost}}
    public {{classname}}(String appId, String apiKey) {
        this(appId, apiKey, new HttpRequester(getDefaultHosts(appId)), null);
    }

    public {{classname}}(String appId, String apiKey, UserAgent.Segment[] userAgentSegments) {
        this(appId, apiKey, new HttpRequester(getDefaultHosts(appId)), userAgentSegments);
    }
    {{/hasRegionalHost}}

    public {{classname}}(String appId, String apiKey, Requester requester) {
        this(appId, apiKey, requester, null);
    }

    public {{classname}}(String appId, String apiKey, Requester requester, UserAgent.Segment[] userAgentSegments) {
        super(appId, apiKey, requester, "{{{baseName}}}", userAgentSegments);
    }

    {{^hasRegionalHost}}
    private static List<StatefulHost> getDefaultHosts(String appId) {
      List<StatefulHost> hosts = new ArrayList<StatefulHost>();
      hosts.add(new StatefulHost(appId + "-dsn.algolia.net", "https", EnumSet.of(CallType.READ)));
      hosts.add(new StatefulHost(appId + ".algolia.net", "https", EnumSet.of(CallType.WRITE)));

      List<StatefulHost> commonHosts = new ArrayList<StatefulHost>();
      hosts.add(new StatefulHost(appId + "-1.algolianet.net", "https", EnumSet.of(CallType.READ, CallType.WRITE)));
      hosts.add(new StatefulHost(appId + "-2.algolianet.net", "https", EnumSet.of(CallType.READ, CallType.WRITE)));
      hosts.add(new StatefulHost(appId + "-3.algolianet.net", "https", EnumSet.of(CallType.READ, CallType.WRITE)));

      Collections.shuffle(commonHosts, new Random());

      return Stream.concat(hosts.stream(), commonHosts.stream()).collect(Collectors.toList());
    }
    {{/hasRegionalHost}}

    {{#hasRegionalHost}}
    private static List<StatefulHost> getDefaultHosts(String region) {
      List<StatefulHost> hosts = new ArrayList<StatefulHost>();

      String url = {{#fallbackToAliasHost}}region == null ? "{{{hostWithFallback}}}" : {{/fallbackToAliasHost}} "{{{host}}}".replace("{region}", region);

      hosts.add(new StatefulHost(url, "https", EnumSet.of(CallType.READ, CallType.WRITE)));
      return hosts;
    }
    {{/hasRegionalHost}}

    {{#operation}}
    /**
     * {{&notes}}{{#allParams}}
     * @param {{paramName}} {{&description}}{{#required}} (required){{/required}}{{^required}} (optional{{^isContainer}}{{#defaultValue}}, default to {{.}}{{/defaultValue}}{{/isContainer}}){{/required}}{{/allParams}}{{#returnType}}
     * @return {{.}}{{/returnType}}
     * @throws AlgoliaRuntimeException If fail to call the API, e.g. server error or cannot deserialize the response body
     {{#isDeprecated}}
     * @deprecated
     {{/isDeprecated}}
        {{#externalDocs}}
     * {{&description}}
     * @see <a href="{{url}}">{{&summary}} Documentation</a>
        {{/externalDocs}}
     */
    {{#isDeprecated}}
    @Deprecated
    {{/isDeprecated}}
    public {{#returnType}}{{{.}}} {{/returnType}}{{^returnType}}void {{/returnType}}{{operationId}}({{#allParams}}{{{dataType}}} {{paramName}}{{^-last}}, {{/-last}}{{/allParams}}) throws AlgoliaRuntimeException {
        return LaunderThrowable.await({{operationId}}Async({{#allParams}}{{paramName}}{{^-last}}, {{/-last}}{{/allParams}}));
    }

  {{#optionalParams.0}}
  public {{#returnType}}{{{.}}} {{/returnType}}{{^returnType}}void {{/returnType}}{{operationId}}({{#requiredParams}}{{{dataType}}} {{paramName}}{{^-last}}, {{/-last}}{{/requiredParams}}) throws AlgoliaRuntimeException {
    {{#returnType}}return {{/returnType}}this.{{operationId}}({{#requiredParams}}{{paramName}}{{^-last}},{{/-last}}{{/requiredParams}}{{#requiredParams.0}},{{/requiredParams.0}}{{#optionalParams}}null{{^-last}},{{/-last}}{{/optionalParams}});
  }
  {{/optionalParams.0}}

  /**
  * (asynchronously)
  * {{notes}}{{#allParams}}
  * @param {{paramName}} {{{description}}}{{#required}} (required){{/required}}{{^required}} (optional{{^isContainer}}{{#defaultValue}}, default to {{.}}{{/defaultValue}}{{/isContainer}}){{/required}}{{/allParams}}
  * @return The awaitable future
  * @throws AlgoliaRuntimeException If fail to process the API call, e.g. serializing the request body object
  {{#isDeprecated}}
  * @deprecated
  {{/isDeprecated}}
  {{#externalDocs}}
  * {{&description}}
  * @see <a href="{{url}}">{{&summary}} Documentation</a>
  {{/externalDocs}}
  */
  {{#isDeprecated}}
  @Deprecated
  {{/isDeprecated}}
  public CompletableFuture<{{{returnType}}}> {{operationId}}Async({{#allParams}}{{{dataType}}} {{paramName}}{{^-last}},{{/-last}} {{/allParams}}) throws AlgoliaRuntimeException {
    {{#allParams}}{{#required}}
    if ({{paramName}} == null) {
        throw new AlgoliaRuntimeException("Missing the required parameter '{{paramName}}' when calling {{operationId}}(Async)");
    }
    {{/required}}{{/allParams}}

    Object bodyObj = {{#bodyParam}}{{paramName}}{{/bodyParam}}{{^bodyParam}}null{{/bodyParam}};

    // create path and map variables
    String requestPath = "{{{path}}}"{{#vendorExtensions}}{{#pathParams}}.replaceAll(
        {{=<% %>=}}"\\{<%baseName%>\\}"<%={{ }}=%>,
        {{#x-is-custom-request}}{{{paramName}}}.toString(){{/x-is-custom-request}}{{^x-is-custom-request}}this.escapeString({{{paramName}}}.toString()){{/x-is-custom-request}}
    ){{/pathParams}}{{/vendorExtensions}};

    {{javaUtilPrefix}}Map<String, String> queryParams = new {{javaUtilPrefix}}HashMap<String, String>();
    {{javaUtilPrefix}}Map<String, String> headers = new {{javaUtilPrefix}}HashMap<String, String>();

    {{#vendorExtensions}}{{#queryParams}}
    if ({{paramName}} != null) {
      {{^x-is-custom-request}}
        queryParams.put("{{baseName}}", parameterToString({{paramName}}));
      {{/x-is-custom-request}}
      {{#x-is-custom-request}}
        for (Map.Entry<String, Object> parameter : parameters.entrySet()) {
          queryParams.put(parameter.getKey().toString(), parameterToString(parameter.getValue()));
        }
      {{/x-is-custom-request}}
    }

    {{/queryParams}}{{/vendorExtensions}}
    {{#headerParams}}
    if ({{paramName}} != null) {
        headers.put("{{baseName}}", this.parameterToString({{paramName}}));
    }

    {{/headerParams}}
    Call call = this.buildCall(requestPath, "{{httpMethod}}", queryParams, bodyObj, headers);
    Type returnType = new TypeToken<{{{returnType}}}>() {}.getType();
    return this.executeAsync(call, returnType);
  }
  {{/operation}}
}
{{/operations}}
