package com.algolia.methods.requests;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;

import java.util.*;

import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.TestInstance;
import org.junit.jupiter.api.BeforeAll;
import com.google.gson.reflect.TypeToken;

import com.algolia.utils.JSON;
import com.algolia.utils.ClientOptions;
import com.algolia.utils.RequestOptions;
import com.algolia.model.{{import}}.*;
import com.algolia.api.{{client}};
import org.skyscreamer.jsonassert.JSONAssert;
import org.skyscreamer.jsonassert.JSONCompareMode;

import com.algolia.utils.HttpRequester;
import com.algolia.EchoInterceptor;
import com.algolia.EchoResponse;

@TestInstance(TestInstance.Lifecycle.PER_CLASS)
class {{client}}RequestsTests {
    private {{client}} client;
    private EchoInterceptor echo;

    @BeforeAll
    void init() {
        HttpRequester requester = new HttpRequester();
        echo = new EchoInterceptor();
        requester.addInterceptor(echo.getEchoInterceptor());
        client = new {{client}}("appId", "apiKey", {{#hasRegionalHost}}"{{defaultRegion}}", {{/hasRegionalHost}}new ClientOptions().setRequester(requester));
    }

    {{#blocksRequests}}
    {{#tests}}
    @Test
    @DisplayName("{{{testName}}}")
    void {{method}}Test{{testIndex}}() {
        {{#parametersWithDataType}}{{> generateParams}}{{/parametersWithDataType}}

        {{#hasRequestOptions}}
          RequestOptions requestOptions = new RequestOptions();
          {{#requestOptions.queryParameters.parametersWithDataType}}
            requestOptions.addExtraQueryParameters("{{{key}}}", {{> requests/requestOptionsParams}});
          {{/requestOptions.queryParameters.parametersWithDataType}}
          {{#requestOptions.headers.parametersWithDataType}}
            requestOptions.addExtraHeader("{{{key}}}", "{{{value}}}");
          {{/requestOptions.headers.parametersWithDataType}}
        {{/hasRequestOptions}}

        assertDoesNotThrow(() -> {
            client.{{method}}({{#parametersWithDataType}}{{> maybeConvertOneOf}}{{^-last}},{{/-last}}{{/parametersWithDataType}}{{#hasRequestOptions}}, requestOptions{{/hasRequestOptions}});
        });
        EchoResponse req = echo.getLastResponse();

        assertEquals(req.path, "{{{request.path}}}");
        assertEquals(req.method, "{{{request.method}}}");

        {{#request.body}}
        assertDoesNotThrow(() -> {
            JSONAssert.assertEquals("{{#lambda.escapeQuotes}}{{{request.body}}}{{/lambda.escapeQuotes}}", req.body, JSONCompareMode.STRICT);
        });
        {{/request.body}}

        {{#request.queryParameters}}
        Map<String, String> expectedQuery = JSON.deserialize("{{#lambda.escapeQuotes}}{{{request.queryParameters}}}{{/lambda.escapeQuotes}}", new TypeToken<HashMap<String, String>>() {}.getType());
        Map<String, Object> actualQuery = req.queryParameters;

        assertEquals(expectedQuery.size(), actualQuery.size());
        for (Map.Entry<String, Object> p : actualQuery.entrySet()) {
          assertEquals(expectedQuery.get(p.getKey()), p.getValue());
        }
        {{/request.queryParameters}}

        {{#request.headers}}
        Map<String, String> expectedHeaders = JSON.deserialize("{{#lambda.escapeQuotes}}{{{request.headers}}}{{/lambda.escapeQuotes}}", new TypeToken<HashMap<String, String>>() {}.getType());
        Map<String, String> actualHeaders = req.headers;

        for (Map.Entry<String, String> p : expectedHeaders.entrySet()) {
          assertEquals(actualHeaders.get(p.getKey()), p.getValue());
        }
        {{/request.headers}}
    }
    {{/tests}}
    {{/blocksRequests}}
}
